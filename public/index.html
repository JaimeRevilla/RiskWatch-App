<!DOCTYPE html>
<html>
<head>
    <title>RiskWatchApp Web</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Mapa de Ubicaciones</h1>
        <p>Visualización de datos de ubicación y altura</p>
    </header>

    <div id="main-container">
        <div id="map-container">
            <div id="map"></div>
        </div>
        <div id="hrv-container">
            <h2>Gráfico de HRV</h2>
            <canvas id="hrv-chart"></canvas>
        </div>
    </div>

    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p>ATENCION, APROXIMANDOSE A PARADA DE METRO TENGA PRECAUCION Y RELAJESE!!</p>
            <button onclick="closeModal()">Aceptar</button>
        </div>
    </div>

    <footer>
        <p>Desarrollado por Jaime Revilla</p>
    </footer>

    <script>
        // Configura Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDIJorV_JDC03nbKYBR7wkeKjBJLcHcxo",
            authDomain: "riskwatchapp-5ec8b.firebaseapp.com",
            databaseURL: "https://riskwatchapp-5ec8b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "riskwatchapp-5ec8b",
            storageBucket: "riskwatchapp-5ec8b.appspot.com",
            messagingSenderId: "162678165225",
            appId: "1:162678165225:web:3c28dd0d756ade7742a78"
        };

        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const storageRef = storage.ref();

        // Inicializa el mapa
        const map = L.map('map').setView([43.263008, -2.934244], 13); // Coordenadas iniciales y zoom

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Coordenadas de las paradas de metro
        const metroStations = [
            { lat: 43.270514, lon: -2.949449, name: "Deusto" },
            { lat: 43.262668, lon: -2.946009, name: "San Mames" },
            { lat: 43.260841, lon: -2.940002, name: "Indautxu" },
            { lat: 43.263008, lon: -2.934244, name: "Moyua" },
            { lat: 43.261320, lon: -2.927671, name: "Abando" }
        ];

        // Añadir círculos para las paradas de metro
        metroStations.forEach(station => {
            L.circle([station.lat, station.lon], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: 100
            }).bindPopup(`<b>Parada de Metro:</b> ${station.name}`).addTo(map);
        });

        // Función para obtener la URL de descarga del archivo CSV más reciente en un directorio específico
        function fetchLatestCSV(directory, fileIdentifier) {
            return storageRef.child(directory).listAll().then(function(result) {
                const csvFiles = result.items.filter(item => item.name.includes(fileIdentifier));
                if (csvFiles.length === 0) {
                    throw new Error(`No se encontraron archivos CSV con el identificador: ${fileIdentifier}`);
                }

                // Ordenar los archivos por nombre (asumiendo que los nombres de archivo contienen fechas y se ordenan lexicográficamente)
                csvFiles.sort((a, b) => b.name.localeCompare(a.name));
                console.log(`Archivo CSV más reciente para ${fileIdentifier}:`, csvFiles[0].name);
                return csvFiles[0].getDownloadURL().then(function(url) {
                    return fetch(url).then(response => response.text());
                });
            });
        }

        // Función para procesar los datos de ubicación
        function processLocationData(data) {
            console.log('Datos de ubicación CSV:', data);

            // Partir los datos basados en la coma
            const parts = data.split(',');

            if (parts.length === 4) {
                const lat = parseFloat(parts[0] + '.' + parts[1]);
                const lon = parseFloat(parts[2] + '.' + parts[3]);
                console.log('Latitud:', lat, 'Longitud:', lon);

                if (!isNaN(lat) && !isNaN(lon)) {
                    return { lat, lon };
                } else {
                    console.error('Error en la conversión de coordenadas:', parts);
                    return null;
                }
            } else {
                console.error('Formato de datos incorrecto:', data);
                return null;
            }
        }

        // Función para procesar los datos de altura
        function processHeightData(data) {
            console.log('Datos de altura CSV:', data);
            const height = parseFloat(data.trim());
            if (!isNaN(height)) {
                return height;
            } else {
                console.error('Error en la conversión de la altura:', data);
                return null;
            }
        }

        // Función para procesar los datos de HRV (Stress)
        function processHRVData(data) {
            console.log('Datos de HRV CSV:', data);
            const rows = data.trim().split('\n');
            const hrvValues = [];

            rows.forEach(row => {
                const columns = row.split(',');
                if (columns.length > 1) {
                    const hrv = parseFloat(columns[1]);
                    if (hrv !== 0 && !isNaN(hrv)) {
                        hrvValues.push(hrv);
                    }
                }
            });

            if (hrvValues.length > 0) {
                return hrvValues;
            } else {
                console.error('No se encontraron valores válidos de HRV');
                return null;
            }
        }

        // Función para crear el gráfico de líneas con alerta
        function createHRVChart(hrvValues) {
            const ctx = document.getElementById('hrv-chart').getContext('2d');
            const data = {
                labels: hrvValues.map((_, index) => index + 1),
                datasets: [{
                    label: 'Variabilidad de la Frecuencia Cardíaca (HRV)',
                    data: hrvValues,
                    borderColor: hrvValues.map(value => value > 110 ? 'rgba(255, 0, 0, 1)' : 'rgba(75, 192, 192, 1)'),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 2,
                    pointBackgroundColor: hrvValues.map(value => value > 110 ? 'rgba(255, 0, 0, 1)' : 'rgba(75, 192, 192, 1)'),
                    pointBorderColor: hrvValues.map(value => value > 110 ? 'rgba(255, 0, 0, 1)' : 'rgba(75, 192, 192, 1)'),
                    pointRadius: 5,
                    fill: true,
                    tension: 0.4
                }]
            };

            const options = {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Tiempo'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'HRV'
                        }
                    }
                },
                plugins: {
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: 110,
                                yMax: 110,
                                borderColor: 'rgb(255, 99, 132)',
                                borderWidth: 2,
                                label: {
                                    enabled: true,
                                    content: 'Alerta HRV > 110',
                                    position: 'end'
                                }
                            }
                        }
                    }
                }
            };

            const hrvChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: options
            });
        }

        // Función para comprobar si la ubicación está dentro de algún círculo
        function checkProximity(location) {
            metroStations.forEach(station => {
                const distance = map.distance([location.lat, location.lon], [station.lat, station.lon]);
                if (distance <= 100) {
                    showModal();
                }
            });
        }

        // Función para mostrar el modal de alerta
        function showModal() {
            document.getElementById('alert-modal').style.display = 'block';
        }

        // Función para cerrar el modal de alerta
        function closeModal() {
            document.getElementById('alert-modal').style.display = 'none';
        }

        // Función principal para cargar y mostrar los datos en el mapa y gráfico de líneas
        async function loadDataAndDisplay() {
            try {
                // Obtener datos de ubicación
                const locationData = await fetchLatestCSV('Datos_An', '_locationData.csv');
                const location = processLocationData(locationData);

                // Obtener datos de altura
                const heightData = await fetchLatestCSV('Datos_An', '_heightData.csv');
                const height = processHeightData(heightData);

                // Obtener datos de HRV
                const hrvData = await fetchLatestCSV('Datos_An', '_data_stress.csv');
                const hrvValues = processHRVData(hrvData);

                // Mostrar datos en el mapa
                if (location && !isNaN(height)) {
                    const { lat, lon } = location;
                    const marker = L.marker([lat, lon]).addTo(map);
                    marker.bindPopup(`<b>Latitud:</b> ${lat}, <b>Longitud:</b> ${lon}, <b>Altura:</b> ${height} metros`);
                    map.setView([lat, lon], 10); // Zoom al primer marcador
                    checkProximity(location); // Comprobar proximidad a paradas de metro
                }

                // Mostrar datos de HRV en el gráfico de líneas
                if (hrvValues) {
                    createHRVChart(hrvValues);
                }
            } catch (error) {
                console.error('Error al cargar y mostrar los datos:', error);
            }
        }

        // Ejecutar la función principal
        loadDataAndDisplay();
    </script>
</body>
</html>